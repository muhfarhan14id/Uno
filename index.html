<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNO Fixed: Inflation & Combo</title>
    <style>
        /* --- STYLE ORIGINAL (DIPERBAIKI AGAR TIDAK GLITCH) --- */
        :root {
            --red: #ff5555;
            --green: #55aa55;
            --blue: #5555ff;
            --yellow: #ffaa00;
            --black: #333;
            --gold: #f1c40f; /* Warna Inflasi */
            --bg: #2c3e50;
            --panel: #34495e;
            --text: #ecf0f1;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #main-area {
            flex: 3;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #sidebar {
            flex: 1;
            background-color: var(--panel);
            border-left: 2px solid #222;
            padding: 15px;
            display: flex;
            flex-direction: column;
            max-width: 280px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .zone {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
        }

        #ai-zone {
            flex: 1;
            align-items: flex-start;
            padding-top: 10px;
        }

        #table-zone {
            flex: 1.5;
            background: rgba(0,0,0,0.1);
            border-radius: 20px;
            margin: 10px;
            gap: 40px;
        }

        #player-zone {
            flex: 1.2;
            align-items: flex-end;
            padding-bottom: 20px;
            padding-top: 40px; /* Ruang untuk kartu naik */
            overflow-x: auto;
            min-height: 150px;
        }

        /* --- KARTU (SAMA PERSIS) --- */
        .card {
            width: 80px;
            height: 120px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 24px;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, margin 0.2s;
            border: 4px solid white;
            margin: 0 -15px; /* Overlap */
            flex-shrink: 0;
        }

        .card:hover {
            transform: translateY(-20px) scale(1.05);
            z-index: 50;
        }

        /* COMBO SELECTION STYLE */
        .card.selected {
            transform: translateY(-35px) scale(1.1) !important;
            border-color: #00ff00;
            box-shadow: 0 0 15px #00ff00;
            z-index: 100;
        }

        .card.disabled {
            filter: grayscale(0.8) brightness(0.7);
            cursor: not-allowed;
            pointer-events: none;
        }

        .card-inner {
            width: 80%;
            height: 85%;
            border-radius: 50% / 10%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 1px 1px 2px black;
            transform: rotate(-45deg);
        }

        .card[data-color="red"] { background-color: var(--red); }
        .card[data-color="green"] { background-color: var(--green); }
        .card[data-color="blue"] { background-color: var(--blue); }
        .card[data-color="yellow"] { background-color: var(--yellow); }
        .card[data-color="black"] { background-color: var(--black); }
        
        /* INFLATION STYLE */
        .card[data-color="gold"] { 
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            border-color: #fffacd;
        }
        .card[data-color="gold"] .card-inner { font-size: 20px; }

        .card-back {
            background: repeating-linear-gradient(45deg, #111, #111 10px, #333 10px, #333 20px);
            border: 4px solid white;
        }
        .card-back .card-inner { display: none; }

        .ai-hand {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 15px;
        }
        .ai-hand-cards { display: flex; }
        .ai-card {
            width: 35px; height: 50px;
            margin: 0 -18px;
            border-radius: 4px;
            border-width: 2px;
        }

        /* --- UI BUTTONS --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
        }
        .btn-primary { background-color: #3498db; color: white; }
        .btn-danger { background-color: #e74c3c; color: white; }

        /* FLOATING COMBO BUTTON */
        #combo-btn {
            position: absolute;
            bottom: 170px; /* Terapung di atas kartu */
            left: 50%;
            transform: translateX(-50%);
            background: #2ecc71;
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
            z-index: 200;
        }

        #uno-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-weight: 900; font-size: 20px;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: absolute;
            right: 30px; bottom: 180px;
            z-index: 50;
            cursor: pointer;
        }
        #uno-btn.active { background: #27ae60; border-color: #2ecc71; animation: none; }

        #log-container {
            flex: 1;
            background: rgba(0,0,0,0.2);
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
            font-family: monospace;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #444;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #444; }

        /* MODALS */
        .modal {
            display: flex; /* Flex by default to center */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999; /* Paling atas */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--panel);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-width: 300px;
            border: 1px solid #555;
        }
        .color-picker-btn {
            width: 50px; height: 50px;
            margin: 5px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            display: inline-block;
        }

        #turn-indicator {
            position: absolute;
            top: 15px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 18px;
            color: white;
            z-index: 10;
        }
    </style>
</head>
<body>

<!-- SETUP MODAL -->
<div id="setup-modal" class="modal">
    <div class="modal-content">
        <h2>UNO PRO MAX</h2>
        <p>Fitur: Combo System & Inflasi +100</p>
        <div style="margin: 20px 0;">
            <label>Jumlah Bot:</label>
            <select id="ai-count" style="padding: 5px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="startGame()">MULAI GAME</button>
    </div>
</div>

<!-- COLOR PICKER -->
<div id="color-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Pilih Warna</h3>
        <div class="color-picker-btn" style="background:var(--red)" onclick="resolveWild('red')"></div>
        <div class="color-picker-btn" style="background:var(--green)" onclick="resolveWild('green')"></div>
        <div class="color-picker-btn" style="background:var(--blue)" onclick="resolveWild('blue')"></div>
        <div class="color-picker-btn" style="background:var(--yellow)" onclick="resolveWild('yellow')"></div>
    </div>
</div>

<!-- GAME UI -->
<div id="game-layout">
    <div id="main-area">
        <div id="turn-indicator">Siap...</div>
        
        <div id="ai-zone" class="zone"></div>

        <div id="table-zone" class="zone">
            <div id="draw-pile" class="card card-back" onclick="playerDrawCard()">
                <div class="card-inner">UNO</div>
            </div>
            <div id="discard-pile"></div>
        </div>

        <button id="combo-btn" onclick="submitPlayerMove()">MAINKAN KARTU</button>

        <div id="player-zone" class="zone"></div>

        <button id="uno-btn" onclick="sayUno()">UNO!</button>
    </div>

    <div id="sidebar">
        <h3>Status</h3>
        <p>Arah: <span id="status-direction">Clockwise</span></p>
        <p>Warna: <span id="status-color" style="font-weight:bold">-</span></p>
        <p>Stack: <span id="status-stack" style="font-size:28px; color:var(--red); font-weight:bold;">0</span></p>
        <div style="flex-grow: 1;"></div>
        <button class="btn btn-danger" onclick="location.reload()">Reset</button>
        <div style="margin-top:10px; font-weight:bold;">Log:</div>
        <div id="log-container"></div>
    </div>
</div>

<script>
/**
 * UNO ENGINE - STABLE RELEASE
 * No external libraries. Pure JS OOP.
 */

// --- CONFIG ---
const COLORS = ['red', 'green', 'blue', 'yellow'];
const SPECIALS = ['skip', 'reverse', 'draw2'];
// Kartu 'draw100' adalah kartu Inflasi
const WILDS = ['wild', 'wild4', 'draw100'];

// --- CLASSES ---

class Card {
    constructor(color, value, type) {
        this.color = color; 
        this.value = value; 
        this.type = type;   
        this.tempColor = null; // Warna sementara wild
        this.id = Math.random().toString(36).substr(2, 9);
    }

    getDisplayColor() { return this.tempColor || this.color; }

    getSymbol() {
        if (this.type === 'number') return this.value;
        if (this.type === 'skip') return 'âŠ˜';
        if (this.type === 'reverse') return 'â‡„';
        if (this.type === 'draw2') return '+2';
        if (this.type === 'wild') return 'ðŸŒˆ';
        if (this.type === 'wild4') return '+4';
        if (this.type === 'draw100') return '+100'; // Inflasi
        return '?';
    }
}

class Deck {
    constructor() { this.cards = []; this.reset(); }
    
    reset() {
        this.cards = [];
        // Kartu Angka & Aksi Biasa
        for (let c of COLORS) {
            this.cards.push(new Card(c, 0, 'number'));
            for (let i = 1; i <= 9; i++) {
                this.cards.push(new Card(c, i, 'number'));
                this.cards.push(new Card(c, i, 'number'));
            }
            for (let s of SPECIALS) {
                this.cards.push(new Card(c, null, s));
                this.cards.push(new Card(c, null, s));
            }
        }
        // Kartu Wild
        for (let i = 0; i < 4; i++) {
            this.cards.push(new Card('black', null, 'wild'));
            this.cards.push(new Card('black', null, 'wild4'));
        }
        // Kartu INFLASI (+100) - Ada 4 buah
        for (let i = 0; i < 4; i++) {
            this.cards.push(new Card('gold', null, 'draw100'));
        }
        this.shuffle();
    }

    shuffle() {
        for (let i = this.cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
        }
    }

    draw() {
        if (this.cards.length === 0) return null;
        return this.cards.pop();
    }
}

class Player {
    constructor(name, isAi) {
        this.name = name;
        this.isAi = isAi;
        this.hand = [];
        this.saidUno = false;
    }

    addCard(card) {
        this.hand.push(card);
        this.saidUno = false;
    }

    removeCards(indices) {
        // Sort descending agar splice tidak merusak index
        indices.sort((a, b) => b - a);
        const removed = [];
        indices.forEach(idx => {
            removed.push(this.hand.splice(idx, 1)[0]);
        });
        return removed.reverse(); // Kembalikan urutan asli
    }
}

class GameEngine {
    constructor() {
        this.deck = new Deck();
        this.players = [];
        this.discardPile = [];
        this.turnIndex = 0;
        this.direction = 1; // 1 or -1
        this.drawStack = 0;
        this.active = false;
        this.currentColor = null;
    }

    start(aiCount) {
        this.players = [new Player("ANDA", false)];
        for(let i=1; i<=aiCount; i++) this.players.push(new Player(`BOT ${i}`, true));
        
        // Deal 7 cards
        this.deck.reset();
        for(let p of this.players) {
            for(let k=0; k<7; k++) p.addCard(this.deck.draw());
        }

        // Start card (cannot be action for simplicity)
        let first;
        do {
            first = this.deck.draw();
            this.discardPile.push(first);
        } while (first.type !== 'number' && first.color !== 'gold');

        this.currentColor = first.color;
        this.active = true;
        
        updateUI();
        log(`Game dimulai! Awal: ${first.color} ${first.value}`);
        this.nextTurn();
    }

    async nextTurn() {
        if (!this.active) return;
        const p = this.players[this.turnIndex];
        
        updateUI();
        document.getElementById('turn-indicator').innerText = `Giliran: ${p.name}`;

        if (p.isAi) {
            disableControls(true);
            await new Promise(r => setTimeout(r, 1200)); // AI thinking
            this.aiMove(p);
        } else {
            disableControls(false); // Human move
        }
    }

    aiMove(p) {
        const top = this.discardPile[this.discardPile.length-1];
        
        // 1. Cari kartu valid di tangan
        // AI Logic: Prioritaskan Combo jika ada
        let bestMove = null;

        for (let i = 0; i < p.hand.length; i++) {
            const card = p.hand[i];
            if (this.isValid(card, top)) {
                // Found starter, look for combos
                const combo = [i];
                for (let j = 0; j < p.hand.length; j++) {
                    if (i===j) continue;
                    const c2 = p.hand[j];
                    // Simple combo logic: exact symbol match
                    if (c2.getSymbol() === card.getSymbol() && c2.color !== 'black') {
                         combo.push(j);
                    }
                }
                bestMove = combo;
                break; // Take first valid option
            }
        }

        if (bestMove) {
            // Handle Wild Color
            const first = p.hand[bestMove[0]];
            if (first.color === 'black' || first.color === 'gold') {
                const colors = ['red','green','blue','yellow'];
                first.tempColor = colors[Math.floor(Math.random()*4)];
            }
            this.playCards(p, bestMove);
        } else {
            this.drawCards(p);
        }
    }

    isValid(card, top) {
        // Stack Rule
        if (this.drawStack > 0) {
            if (card.type === 'draw100') return true;
            if (card.type === 'draw2' && top.type === 'draw2') return true;
            if (card.type === 'wild4' && top.type === 'wild4') return true;
            return false;
        }
        // Normal Rule
        if (card.color === 'black' || card.color === 'gold') return true;
        if (card.color === this.currentColor) return true;
        if (card.value !== null && card.value === top.value) return true;
        if (card.type !== 'number' && card.type === top.type) return true;
        return false;
    }

    playCards(player, indices) {
        const played = player.removeCards(indices);
        played.forEach(c => this.discardPile.push(c));
        
        const last = played[played.length-1];
        this.currentColor = last.getDisplayColor();

        let msg = `${player.name} main ${indices.length}x [${last.getSymbol()}]`;
        if (last.type === 'draw100') msg += " INFLASI!";
        log(msg);

        if (player.hand.length === 0) {
            alert(`${player.name} MENANG!`);
            this.active = false;
            return;
        }

        // Apply Effects
        let skip = 0;
        played.forEach(c => {
            if (c.type === 'draw100') this.drawStack += 100;
            else if (c.type === 'wild4') this.drawStack += 4;
            else if (c.type === 'draw2') this.drawStack += 2;
            else if (c.type === 'skip') skip++;
            else if (c.type === 'reverse') {
                this.direction *= -1;
                if (this.players.length === 2) skip++;
            }
        });

        // Calculate next turn
        let steps = 1 + skip;
        for(let i=0; i<steps; i++) {
            this.turnIndex = (this.turnIndex + this.direction + this.players.length) % this.players.length;
        }

        setTimeout(() => this.nextTurn(), 800);
    }

    drawCards(player) {
        let count = this.drawStack > 0 ? this.drawStack : 1;
        log(`${player.name} ambil ${count} kartu.`);
        
        // Safety cap for rendering
        const actualDraw = count; // Logic handles it
        
        for(let i=0; i<actualDraw; i++) {
            let c = this.deck.draw();
            if(!c) {
                // Reshuffle simple
                if(this.discardPile.length > 1) {
                    const top = this.discardPile.pop();
                    this.deck.cards = this.discardPile;
                    this.discardPile = [top];
                    this.deck.shuffle();
                    c = this.deck.draw();
                } else break;
            }
            if(c) player.addCard(c);
        }
        
        this.drawStack = 0;
        this.turnIndex = (this.turnIndex + this.direction + this.players.length) % this.players.length;
        setTimeout(() => this.nextTurn(), 800);
    }
}

// --- GLOBAL VARIABLES ---
const game = new GameEngine();
let selectedIndices = new Set(); // Stores index of selected cards

// --- UI FUNCTIONS ---

function startGame() {
    try {
        const count = document.getElementById('ai-count').value;
        document.getElementById('setup-modal').style.display = 'none';
        game.start(parseInt(count));
    } catch (e) {
        alert("Error starting game: " + e);
        console.error(e);
    }
}

function updateUI() {
    // Status
    document.getElementById('status-direction').innerText = game.direction === 1 ? "Searah Jarum Jam" : "Berlawanan";
    const cEl = document.getElementById('status-color');
    cEl.innerText = game.currentColor.toUpperCase();
    cEl.style.color = game.currentColor === 'black' ? 'white' : game.currentColor;
    if(game.currentColor === 'gold') cEl.style.color = '#f1c40f';
    document.getElementById('status-stack').innerText = game.drawStack;

    // Discard Pile
    const discardDiv = document.getElementById('discard-pile');
    discardDiv.innerHTML = '';
    if (game.discardPile.length > 0) {
        const top = game.discardPile[game.discardPile.length-1];
        discardDiv.appendChild(createCardHTML(top));
    }

    // Player Hand
    const handDiv = document.getElementById('player-zone');
    handDiv.innerHTML = '';
    const p = game.players[0]; // Human
    p.hand.forEach((card, idx) => {
        const el = createCardHTML(card);
        el.onclick = () => toggleSelect(idx, el);
        if (selectedIndices.has(idx)) el.classList.add('selected');
        handDiv.appendChild(el);
    });

    // AI Zones
    const aiDiv = document.getElementById('ai-zone');
    aiDiv.innerHTML = '';
    for(let i=1; i<game.players.length; i++) {
        const bot = game.players[i];
        const wrapper = document.createElement('div');
        wrapper.className = 'ai-hand';
        if (game.turnIndex === i) wrapper.style.borderBottom = "3px solid yellow";
        
        let html = `<div style="color:#ccc; font-size:12px; margin-bottom:5px;">${bot.name} (${bot.hand.length})</div><div class="ai-hand-cards">`;
        bot.hand.forEach(c => {
            let style = "";
            if(c.color === 'gold') style = "border-color:gold;"; // Hint
            html += `<div class="card ai-card card-back" style="${style}"></div>`;
        });
        html += `</div>`;
        wrapper.innerHTML = html;
        aiDiv.appendChild(wrapper);
    }

    checkComboButton();
}

function createCardHTML(card) {
    const el = document.createElement('div');
    el.className = 'card';
    el.setAttribute('data-color', card.getDisplayColor());
    
    const inner = document.createElement('div');
    inner.className = 'card-inner';
    inner.innerText = card.getSymbol();
    
    // Gradient text for Wild
    if (card.type.startsWith('wild')) {
        inner.style.background = 'conic-gradient(red, yellow, green, blue)';
        inner.style.webkitBackgroundClip = 'text';
        inner.style.color = 'transparent';
    }
    
    el.appendChild(inner);
    return el;
}

function toggleSelect(idx, el) {
    if (game.turnIndex !== 0) return; // Not your turn

    if (selectedIndices.has(idx)) {
        selectedIndices.delete(idx);
        el.classList.remove('selected');
    } else {
        // Combo Check: Must match existing selection symbol
        if (selectedIndices.size > 0) {
            const firstIdx = Array.from(selectedIndices)[0];
            const first = game.players[0].hand[firstIdx];
            const current = game.players[0].hand[idx];
            
            // Strict match for Combo
            if (first.getSymbol() !== current.getSymbol()) {
                // Invalid combo attempt - wiggle animation
                el.style.transform = "rotate(5deg)";
                setTimeout(()=> el.style.transform = "none", 100);
                return;
            }
        }
        selectedIndices.add(idx);
        el.classList.add('selected');
    }
    checkComboButton();
}

function checkComboButton() {
    const btn = document.getElementById('combo-btn');
    const arr = Array.from(selectedIndices);
    
    if (arr.length > 0) {
        // Check validity against table
        const first = game.players[0].hand[arr[0]];
        const top = game.discardPile[game.discardPile.length-1];
        
        if (game.isValid(first, top)) {
            btn.style.display = 'block';
            btn.innerText = `Mainkan (${arr.length})`;
            return;
        }
    }
    btn.style.display = 'none';
}

function submitPlayerMove() {
    const arr = Array.from(selectedIndices).sort((a,b)=>a-b);
    const p = game.players[0];
    const first = p.hand[arr[0]];

    // UNO Check
    if (p.hand.length - arr.length === 1 && !p.saidUno) {
        const uBtn = document.getElementById('uno-btn');
        if (!uBtn.classList.contains('active')) {
            log("Lupa UNO! Denda +2", true);
            game.forceDraw(p, 2);
        }
    }

    if (first.color === 'black' || first.color === 'gold') {
        // Show Color Picker
        document.getElementById('color-modal').style.display = 'flex';
        // Simpan callback global
        window.resolveWild = (col) => {
            document.getElementById('color-modal').style.display = 'none';
            // Set color for all selected wilds
            arr.forEach(i => p.hand[i].tempColor = col);
            finalizeMove(arr);
        };
    } else {
        finalizeMove(arr);
    }
}

function finalizeMove(indices) {
    selectedIndices.clear();
    document.getElementById('combo-btn').style.display = 'none';
    game.playCards(game.players[0], indices);
}

function playerDrawCard() {
    if (game.turnIndex !== 0) return;
    if (selectedIndices.size > 0) {
        selectedIndices.clear();
        updateUI();
        return;
    }
    game.drawCards(game.players[0]);
}

function sayUno() {
    const p = game.players[0];
    p.saidUno = !p.saidUno;
    const btn = document.getElementById('uno-btn');
    if(p.saidUno) btn.classList.add('active');
    else btn.classList.remove('active');
}

function disableControls(disable) {
    const zone = document.getElementById('player-zone');
    const pile = document.getElementById('draw-pile');
    if (disable) {
        zone.style.pointerEvents = 'none';
        zone.style.opacity = '0.7';
        pile.style.pointerEvents = 'none';
    } else {
        zone.style.pointerEvents = 'auto';
        zone.style.opacity = '1';
        pile.style.pointerEvents = 'auto';
    }
}

function log(msg, important=false) {
    const box = document.getElementById('log-container');
    const d = document.createElement('div');
    d.className = 'log-entry';
    if(important) d.style.color = '#e74c3c';
    d.innerText = `> ${msg}`;
    box.prepend(d);
}

</script>
</body>
</html>
